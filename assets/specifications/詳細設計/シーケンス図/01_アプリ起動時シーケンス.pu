@startuml
title 1日の処理シーケンス（初回起動分岐あり）

actor ユーザー
participant "main / AppRootWidget" as Main
participant "onAppStart()" as Entry
participant "AppStartService\n(P2)" as P2
participant "InitialSetupService\n(P1)" as P1
participant "StateJudgeService\n(P3)" as P3
participant "FeedbackService\n(P4)" as P4
participant "NotificationTimeService\n(P5)" as P5
' participant "NotificationService\n(P6)" as P6
database "Repository\n(SQLite)" as DB
participant "OS\n(時刻)" as OS_Time
' participant "OS\n(通知)" as OS_Notify
participant "UI\n(Page)" as UI

== アプリ起動 ==
ユーザー -> Main : アプリ起動
Main -> Entry : onAppStart()

== 起動時判定（P2） ==
Entry -> P2 : handleAppStart()

P2 -> DB : 初回起動フラグ取得
DB --> P2 : 初回起動フラグ

alt 初回起動フラグ == false（初回起動）
  P2 -> P1 : InitialSetup()
  note right
  初回起動シーケンスへ
  end note
end
  P2 -> OS_Time : 現在時刻取得
  P2 -> DB : 最終利用日取得
  P2 -> P2 : 日付変更判定

  alt 日付変更あり
    P2 -> P2 : DateChangeProcess()
    note right
    日付変更時シーケンスへ
    end note
  end


== 状態判定（P3） ==
Entry -> P3 : judgeState()

P3 -> DB : 通知時刻取得
P3 -> DB : FB完了フラグ取得
P3 -> OS_Time : 現在時刻取得
P3 -> P3 : 状態決定(S1/S2/S3)
P3 --> Entry : 状態
Entry --> Main : 状態

== UI分岐 ==
alt S1/S3
  Main -> UI : showMessage(S1/S3)

else S2
  Main -> UI : showFeedbackUI()
  ユーザー -> UI : FB入力
  UI -> P4 : submitFeedback()

  P4 -> DB : FB履歴保存
  P4 -> DB : FB完了フラグ更新
  P4 -> DB : 最終利用日 = 現在日付

  P4 -> P5 : calcNotificationTime()
  note right
  通知時間算出シーケンスへ
  end note
  ' P5 -> DB : 翌日通知時刻保存
  ' P5 -> P6 : registerNotification()
  ' P6 -> OS_Notify : 通知スケジュール

  P4 -> P3 : judgeState()
  P3 --> Entry : S3
  Main -> UI : showMessage(S3)
end

@enduml
