@startuml
title 初回起動シーケンス（P1 → P3連携版）

actor ユーザー
participant "UI\n(TutorialPage)" as UI
participant "AppStartService\n(P2)" as P2
participant "InitialSetupService\n(P1)" as P1
' participant "StateJudgeService\n(P3)" as P3
participant "Repository\n(SQLite)" as DB
participant "OS\n(通知)" as OS_Notify
participant "OS\n(時刻)" as OS_Time


P2 -> P1 : InitialSetup()

== チュートリアル ==
P1 -> UI : showTutorial()
UI -> ユーザー : チュートリアル表示

== ユーザー設定入力 ==
ユーザー -> UI : 終業時間帯入力
ユーザー -> UI : 就寝時間帯入力
UI -> P1 : submitUserSettings()

== 通知許可 ==
P1 -> OS_Notify : 通知許可リクエスト
OS_Notify --> P1 : 許可 / 不許可

note right
通知許可の結果は
状態判定には影響しない
end note

== 初期状態データ生成 ==
P1 -> OS_Time : 現在時刻取得
OS_Time --> P1 : 現在時刻

P1 -> P1 : 初期状態データ生成
note right
・当日FB未完了
end note
P1 -> P1 : 初回通知時刻算出（終業時間帯の中央値）


== データ保存 ==
P1 -> DB : MD_1 初回起動フラグ=OFF
P1 -> DB : MD_2 終業時間帯
P1 -> DB : MD_3 就寝時間帯
P1 -> DB : DD_1 当日通知時刻
P1 -> DB : DD_2 FB完了フラグ=false

' == 状態判定へ委譲 ==
' P1 -> P3 : judgeState()

' P3 -> DB : DD_1 通知時刻
' P3 -> DB : DD_2 FB完了フラグ
' P3 -> OS_Time : 現在時刻取得
' OS_Time --> P3 : 現在時刻

' P3 -> P3 : 状態判定(S1/S2/S3)

' == メッセージ表示 ==
' P3 -> UI : showMessageByState()
' UI -> ユーザー : 状態別メッセージ表示

@enduml
