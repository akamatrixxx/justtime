@startuml
title 日付変更時 処理シーケンス（通知再計算なし・逆探索方式）

participant "AppStartService\n(P2)" as P2
participant "Repository\n(SQLite)" as DB
participant "OS\n(時刻)" as OS_Time
participant "OS\n(通知)" as OS_Notify

== 日付変更判定 ==
P2 -> P2 : ProcessDateChange()

P2 -> DB : 最終利用日取得
P2 -> OS_Time : 現在日付取得

P2 -> P2 : 最終利用日 < 現在日付 ?

alt 未利用日あり

  == 通知時刻探索 ==
  P2 -> P2 : 探索日 = 昨日

  loop 探索日 >= 最終利用日

    P2 -> DB : 探索日のデータ取得

    alt データ存在
      P2 -> DB : 通知時刻取得
      P2 -> P2 : 今日の通知時刻 = 取得値
      break
    else データなし
      P2 -> P2 : 探索日 -1日
    end

  end

  == 当日データ作成 ==
  P2 -> DB : 今日のデータセット作成
  note right
  ・FB完了=false
  ・通知時刻=探索結果
  end note

  P2 -> OS_Notify : 通知スケジュール更新

else 未利用日なし
  note right
  処理なし
  end note
end

@enduml
